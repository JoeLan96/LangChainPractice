# Test01 相关文档内容检索测试(普通文本测试)

本文主要测试相关文档检索是否能够准确检索到相关的内容。

测试的方法有: 1.相似性搜索(欧式距离)，2.最大边际相关性检索（Maximum marginal relevance，MMR）

测试结论：

- 对普通文本，相关性检索可以准确地找到对应的文档块。
- 对数据文本，相关性检索在定制划分块后，可以准确地找到对应的文档块。但是在轻微改变数据后，便无法有效查找到对应的块了。

## 1.1 相似性检索

In [ ]:

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("./LongText.txt")
documents = loader.load()
print(documents)
```

[Document(page_content='# 儿童小故事\n\n## 1、爱笑的小花\n公园里有朵花，真好看，看见小天天，总是笑眯眯的。\n天天问花儿："你叫什么名字？"\n花儿只是笑，不说话。\n天天伸出小手，要采这朵花。\n外公摆摆手说："天天别采！你不采她，花儿总是对你笑，你一采下来，花儿就哭了。"\n天天不想看到小花对他哭，天天没有采。\n天天回家以后，告诉外婆："公园里有一朵花，很乖很乖，对他一直笑，一直笑。"\n外婆说："天天也很乖，你也是一朵爱笑的小花。"\n故事目标：\n1.知道微笑是一种美。\n2.懂得要爱护花。（周末带孩子去公园看花）\n可设置一些问题让幼儿讨论：\n1.小天天和花儿都有一个什么特点让人喜欢？\n2.小天天为什么一直没有摘公园里的那朵花？\n3.外婆为什么说："天天也是一朵爱笑的小花？"\n让幼儿明白：微笑会让大家喜欢，爱护花的孩子更让人喜欢。\n\n## 2、笨狼阿灰\n笨狼阿灰经常想歪点子欺负其他小动物，还得意洋洋。这一天，笨狼阿灰又吓唬小公鸡，\n说要吃掉他。小公鸡请求阿灰晚上再来，笨狼同意了。小动物们知道了，一起来帮小公鸡\n想办法。大家在小公鸡的家里布置了一些特别的陷阱。小狗说："小公鸡，这下你可不用害\n怕了。"笨狼阿灰一走进小公鸡家就掉进了陷阱里，大家高兴得拍手称快。\n引导幼儿讨论下列问题：\n1.笨狼阿灰是一只什么样的狼？你喜欢故事中的小公鸡吗？为什么？\n2.如果笨狼阿灰不同意小公鸡的请求，没有等到晚上就来了，公鸡可以想什么办法呢？向\n幼儿提出新的假设条件，帮助幼儿思考新的可能性，然后要求幼儿想象并表达自己的见\n解。\n\n## 3、小猴子掰玉米\n有一天，一只小猴子下山来.它走到一块玉米地里，看见玉米结得又大又多，非常高兴，就\n掰了一个，扛着往前走。小猴子扛着玉米，走到一棵桃树下。它看见满树的桃子又大又\n红，非常高兴，就扔了玉米去摘桃子。小猴子捧着几个桃子，走到一片瓜地里。它看见满\n地的西瓜又大又圆，非常高兴，就扔了桃子去摘西瓜。小猴子抱着一个大西瓜往回走。走\n着走着，看见一只小兔蹦蹦跳跳的，真可爱。它非常高兴，就扔了西瓜去追小兔。小兔跑\n进树林子，不见了。小猴子只好空着手回家去。\n\n## 4、老爷爷的帽子\n冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。\n\n## 5、想飞的小象\n有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"\n\n## 6、小荷花找朋友\n一朵荷花孤零零地站在池塘里，她感到孤单，因为没有朋友和她玩。一条小鱼游过来，小\n荷花说："小鱼弟弟，咱们一起玩吧。"小鱼说："不行，我还要去参加游泳比赛呢。"说完，\n小鱼就游走了。一只青蛙跳到荷叶上，小荷花说："青蛙哥哥，青蛙哥哥，咱们做朋友\n吧。"小青蛙说："不行，不行，我还要练唱歌呢！"天渐渐黑了，小荷花很伤心。月亮看见\n了，问小荷花："荷花妹妹，你为什么不高兴呢？"小荷花说："因为我没有朋友和我玩。"月\n亮说："那我和你做朋友吧。"小荷花看了看月亮说："可你在天上，我在地上，怎么和我玩\n呢？"月亮说："不要紧，我可以陪你说话呀！可以唱歌、讲故事给你听呀！"于是，月亮天\n天晚上陪小荷花说话，她们俩成了好朋友。\n幼儿讨论：\n1.启发幼儿说一说与好朋友在一起玩开心不开心，为什么？\n2.小鱼弟弟和青蛙哥哥为什么不和荷花妹妹玩？它们怎么说？\n3.小荷花最后找到朋友了吗？\n\n## 7、小猪和靴子\n清晨，小猪去树林里玩。忽然，他发现树边有一个红红的东西，口小底大，摸上去很\n滑："咦，这是什么？好像是个皮袋子，是谁丢的呢？\n小猪手里拿着这东西，嘴里叫着："谁丢了袋子，谁丢了袋子？"\n树上的八哥听见了，"叽叽喳喳"地说："小猪，这不是袋子，是一顶漂亮的红帽子呀！"\n"噢，不是袋子是帽子。"小猪连忙戴在头上，一边走一边叫，"谁丢了帽子，谁丢了帽子？"\n狐狸看见了，嘻嘻地笑起来："小猪，这不是帽子，是一只好看的瓶子呀！"\n"嗯，这瓶子真不错。"小猪采了许多美丽的野花放进瓶子里。\n"谁丢了瓶子？"小猪捧着瓶子走一步，叫一声。\n这时候，来了一只小花狗。他知道了这事，对小猪说："没人丢，没人领，就送给生病的小\n熊吧！"\n小猪和小狗来到了小熊家，把这个没人领的瓶子和花送给小熊。小熊一看，高兴地跳起\n来："哇，这不是瓶子，是我心爱的红靴子呀！"小熊炙得病也好了，三个好朋友嘻嘻哈哈，\n庆祝红靴子找到了主人，回到了家。\n目标：\n1.理解故事内容，学习故事中角色的语言。\n2.理解角色的性格特点，体验乐于助人的情感。\n引导幼儿讨论：你喜欢故事中的小猪吗？为什么？（帮助幼儿总结出小猪的性格特点）\n［憨厚、善良、助人为乐］\n可组织幼儿围绕"我丢了东西以后"为主题进行谈话。例如：你丢过东西吗？心里怎么样？如\n果别人捡到了，还给你，你心里怎么样？如果你捡到了东西会怎么做？\n学习量词的不同用法：一样、一顶、一只、一双。\n\n## 8、借你一把伞（童话）\n下雨了，糟糕了，娜娜没有带伞，娜娜站在雨中。\n小蚂蚁拿着小小的酢浆草走过来，说："借你一把伞。"娜娜拿着，小蚂蚁的伞真小。\n青蛙拿着瓜的叶子跳过来，说："借你一把伞。"青蛙的伞是漏斗伞。\n兔子拿着上头有叶须的有萝卜，说："借你一把伞。"兔子的伞会漏雨。\n小狐狸拿着"芋头叶"给娜娜，小狐狸的伞是不是刚好呢？撑着撑着，啊雨漏下来了，娜娜和\n小动物跑了起来。\n大熊拿着大大的荷叶过来说："借你一把伞。"大熊的伞好大好重啊。\n小狗强强拿着伞跑了过来，说："借你一把伞。"啊，那就是娜娜的伞嘛！\n下雨天，拿着伞排队走，还有谁没有伞吗？\n故事目标：探索像伞的植物，感受故事人文怀的温情。\n幼儿讨论：故事中出现了哪些动物？它们拿了哪些伞？人家借你一把伞（或你借别人一把\n伞），心情会怎样？\n学习句式："××拿着××说：\'借你一把伞\'。"启发幼儿有创意地表演，体验人与人之间互相关\n心的情感。\n\n## 9、胆小先生\n有一位先生，住在一座漂亮的房子里。因为他的胆子很小，大家都电他胆小先生。\n一天，一只大老鼠闯进了他的房子。胆小先生马上去捉，结果在地下室捉住了它。\n"你放了我！"大老鼠挣扎着说，"我要是一跺脚，整个房子就塌了。"\n胆小先生害怕了，连忙放开了他，还允许他住在地下室里。\n地下室里吃的东西真多，大老鼠吃呀，喝呀，真开心。后来，大老鼠生了一窝小老鼠，小\n老鼠又长成大老鼠……很快，地下室住满了老鼠。\n"不行，不行！"大老鼠冲着胆小先生嚷嚷："这么多老鼠住这么一个小小的地下室，而你一\n个人住那么多房间，太不合理了，得换房子。"\n"换房子？"胆小先生住在地下室，老鼠们住进各个房间，他们在宽大的客厅里唱呀，跳呀，\n在喷香的厨房里喝呀，吃呀，每天都像过节一样。\n"你应该搬出去！"大老鼠又冲着胆小先生嚷嚷，"你干嘛住在地下室？这么好的地下室，你\n配住吗？"\n"什么？"胆小先生气愤得跺了一下右脚，"咚--"老鼠们害怕了，他们个个抱头乱窜，以为地\n震了。\n"哦，原来我是很有力量的！"胆小先生抓起旧扫帚，这儿一扑，那儿一打，这儿一戳，那儿\n一捣，老鼠被打得"吱吱"叫，全逃走了。\n胆小先生后来怎么样了？小朋友能猜到吗？\n故事目标：\n1.感受故事人物幽默的语言和夸张的情节所产生的美。\n2.理解童话内容及"胆小先生"的形象特点。\n3.学习故事中人物的对话，根据自己的想象力表演故事。\n幼儿讨论：大老鼠为什么要与胆小先生换房子？胆小先生为什么答应换房子？房子换成\n后，大老鼠又怎么样了？\n胆小先生是一个什么样的人？胆小先生最后有什么变化？\n\n## 10、小猴穿鞋\n有一只小猴跑到山下去，看见人们都穿着鞋走路，感到很好玩。他悄悄地溜到一户人家，\n偷偷地拿了一双鞋跑回山上。他穿上鞋后，很得意地走来走去，伙伴们见了都笑话它。这\n时来了一只凶猛的老虎，猴子们一见纷纷爬上了树。小猴穿着鞋怎么也爬不上树。猴妈妈\n叫他把鞋扔掉。小猴扔掉鞋很快爬上了树，从此再也不乱模仿别人了。\n幼儿讨论：（让孩子想像）\n1.小猴在山下玩时看到什么，它脸上的是什么样的？\n2.小猴怎样溜到别人家里去，它干什么，又怎样想的呢？\n3.小猴怎样跑回山上，它脸上的表情是什么样的，说明了什么？\n4.伙伴们看见小猴穿上了鞋，感到怎样？可能对它说什么？\n5.老虎来了，猴子们心里怎么想？\n6.小猴被妈妈救上了树，脸上的表情是什么样的，说明它心里怎么样的？\n7.小猴最后怎样扔掉了鞋子？小猴的妈妈对它说了些什么？\n8.穿鞋的猴子是什么样的小猴？', metadata={'source': './LongText.txt'})]

```python
from langchain_community.vectorstores import FAISS
from langchain_openai import OpenAIEmbeddings
from langchain_text_splitters import MarkdownHeaderTextSplitter

headers_to_split_on = [
    ("#", "Header 1"),
    ("##", "Header 2"),
    ("###", "Header 3"),
]

# 测试文本采用了 MarkDown 的形式，所以这里使用 MarkDown 来拆分
markdown_splitter = MarkdownHeaderTextSplitter(headers_to_split_on=headers_to_split_on)

texts = markdown_splitter.split_text(documents[0].page_content)
print(texts)

embeddings = OpenAIEmbeddings(
    openai_api_base="https://api.nextapi.fun/v1", 
    openai_api_key="ak-5q53TviefzOYW8xW2F0gFtS20aO2gT288sPWSD92YQpjqmSJ",
)

db = FAISS.from_documents(texts, embeddings)

# 默认情况下，矢量存储检索器使用相似性搜索
retriever = db.as_retriever()
```

[Document(page_content='公园里有朵花，真好看，看见小天天，总是笑眯眯的。\n天天问花儿："你叫什么名字？"\n花儿只是笑，不说话。\n天天伸出小手，要采这朵花。\n外公摆摆手说："天天别采！你不采她，花儿总是对你笑，你一采下来，花儿就哭了。"\n天天不想看到小花对他哭，天天没有采。\n天天回家以后，告诉外婆："公园里有一朵花，很乖很乖，对他一直笑，一直笑。"\n外婆说："天天也很乖，你也是一朵爱笑的小花。"\n故事目标：\n1.知道微笑是一种美。\n2.懂得要爱护花。（周末带孩子去公园看花）\n可设置一些问题让幼儿讨论：\n1.小天天和花儿都有一个什么特点让人喜欢？\n2.小天天为什么一直没有摘公园里的那朵花？\n3.外婆为什么说："天天也是一朵爱笑的小花？"\n让幼儿明白：微笑会让大家喜欢，爱护花的孩子更让人喜欢。', metadata={'Header 1': '儿童小故事', 'Header 2': '1、爱笑的小花'}), Document(page_content='笨狼阿灰经常想歪点子欺负其他小动物，还得意洋洋。这一天，笨狼阿灰又吓唬小公鸡，\n说要吃掉他。小公鸡请求阿灰晚上再来，笨狼同意了。小动物们知道了，一起来帮小公鸡\n想办法。大家在小公鸡的家里布置了一些特别的陷阱。小狗说："小公鸡，这下你可不用害\n怕了。"笨狼阿灰一走进小公鸡家就掉进了陷阱里，大家高兴得拍手称快。\n引导幼儿讨论下列问题：\n1.笨狼阿灰是一只什么样的狼？你喜欢故事中的小公鸡吗？为什么？\n2.如果笨狼阿灰不同意小公鸡的请求，没有等到晚上就来了，公鸡可以想什么办法呢？向\n幼儿提出新的假设条件，帮助幼儿思考新的可能性，然后要求幼儿想象并表达自己的见\n解。', metadata={'Header 1': '儿童小故事', 'Header 2': '2、笨狼阿灰'}), Document(page_content='有一天，一只小猴子下山来.它走到一块玉米地里，看见玉米结得又大又多，非常高兴，就\n掰了一个，扛着往前走。小猴子扛着玉米，走到一棵桃树下。它看见满树的桃子又大又\n红，非常高兴，就扔了玉米去摘桃子。小猴子捧着几个桃子，走到一片瓜地里。它看见满\n地的西瓜又大又圆，非常高兴，就扔了桃子去摘西瓜。小猴子抱着一个大西瓜往回走。走\n着走着，看见一只小兔蹦蹦跳跳的，真可爱。它非常高兴，就扔了西瓜去追小兔。小兔跑\n进树林子，不见了。小猴子只好空着手回家去。', metadata={'Header 1': '儿童小故事', 'Header 2': '3、小猴子掰玉米'}), Document(page_content='冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。', metadata={'Header 1': '儿童小故事', 'Header 2': '4、老爷爷的帽子'}), Document(page_content='有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"', metadata={'Header 1': '儿童小故事', 'Header 2': '5、想飞的小象'}), Document(page_content='一朵荷花孤零零地站在池塘里，她感到孤单，因为没有朋友和她玩。一条小鱼游过来，小\n荷花说："小鱼弟弟，咱们一起玩吧。"小鱼说："不行，我还要去参加游泳比赛呢。"说完，\n小鱼就游走了。一只青蛙跳到荷叶上，小荷花说："青蛙哥哥，青蛙哥哥，咱们做朋友\n吧。"小青蛙说："不行，不行，我还要练唱歌呢！"天渐渐黑了，小荷花很伤心。月亮看见\n了，问小荷花："荷花妹妹，你为什么不高兴呢？"小荷花说："因为我没有朋友和我玩。"月\n亮说："那我和你做朋友吧。"小荷花看了看月亮说："可你在天上，我在地上，怎么和我玩\n呢？"月亮说："不要紧，我可以陪你说话呀！可以唱歌、讲故事给你听呀！"于是，月亮天\n天晚上陪小荷花说话，她们俩成了好朋友。\n幼儿讨论：\n1.启发幼儿说一说与好朋友在一起玩开心不开心，为什么？\n2.小鱼弟弟和青蛙哥哥为什么不和荷花妹妹玩？它们怎么说？\n3.小荷花最后找到朋友了吗？', metadata={'Header 1': '儿童小故事', 'Header 2': '6、小荷花找朋友'}), Document(page_content='清晨，小猪去树林里玩。忽然，他发现树边有一个红红的东西，口小底大，摸上去很\n滑："咦，这是什么？好像是个皮袋子，是谁丢的呢？\n小猪手里拿着这东西，嘴里叫着："谁丢了袋子，谁丢了袋子？"\n树上的八哥听见了，"叽叽喳喳"地说："小猪，这不是袋子，是一顶漂亮的红帽子呀！"\n"噢，不是袋子是帽子。"小猪连忙戴在头上，一边走一边叫，"谁丢了帽子，谁丢了帽子？"\n狐狸看见了，嘻嘻地笑起来："小猪，这不是帽子，是一只好看的瓶子呀！"\n"嗯，这瓶子真不错。"小猪采了许多美丽的野花放进瓶子里。\n"谁丢了瓶子？"小猪捧着瓶子走一步，叫一声。\n这时候，来了一只小花狗。他知道了这事，对小猪说："没人丢，没人领，就送给生病的小\n熊吧！"\n小猪和小狗来到了小熊家，把这个没人领的瓶子和花送给小熊。小熊一看，高兴地跳起\n来："哇，这不是瓶子，是我心爱的红靴子呀！"小熊炙得病也好了，三个好朋友嘻嘻哈哈，\n庆祝红靴子找到了主人，回到了家。\n目标：\n1.理解故事内容，学习故事中角色的语言。\n2.理解角色的性格特点，体验乐于助人的情感。\n引导幼儿讨论：你喜欢故事中的小猪吗？为什么？（帮助幼儿总结出小猪的性格特点）\n［憨厚、善良、助人为乐］\n可组织幼儿围绕"我丢了东西以后"为主题进行谈话。例如：你丢过东西吗？心里怎么样？如\n果别人捡到了，还给你，你心里怎么样？如果你捡到了东西会怎么做？\n学习量词的不同用法：一样、一顶、一只、一双。', metadata={'Header 1': '儿童小故事', 'Header 2': '7、小猪和靴子'}), Document(page_content='下雨了，糟糕了，娜娜没有带伞，娜娜站在雨中。\n小蚂蚁拿着小小的酢浆草走过来，说："借你一把伞。"娜娜拿着，小蚂蚁的伞真小。\n青蛙拿着瓜的叶子跳过来，说："借你一把伞。"青蛙的伞是漏斗伞。\n兔子拿着上头有叶须的有萝卜，说："借你一把伞。"兔子的伞会漏雨。\n小狐狸拿着"芋头叶"给娜娜，小狐狸的伞是不是刚好呢？撑着撑着，啊雨漏下来了，娜娜和\n小动物跑了起来。\n大熊拿着大大的荷叶过来说："借你一把伞。"大熊的伞好大好重啊。\n小狗强强拿着伞跑了过来，说："借你一把伞。"啊，那就是娜娜的伞嘛！\n下雨天，拿着伞排队走，还有谁没有伞吗？\n故事目标：探索像伞的植物，感受故事人文怀的温情。\n幼儿讨论：故事中出现了哪些动物？它们拿了哪些伞？人家借你一把伞（或你借别人一把\n伞），心情会怎样？\n学习句式："××拿着××说：\'借你一把伞\'。"启发幼儿有创意地表演，体验人与人之间互相关\n心的情感。', metadata={'Header 1': '儿童小故事', 'Header 2': '8、借你一把伞（童话）'}), Document(page_content='有一位先生，住在一座漂亮的房子里。因为他的胆子很小，大家都电他胆小先生。\n一天，一只大老鼠闯进了他的房子。胆小先生马上去捉，结果在地下室捉住了它。\n"你放了我！"大老鼠挣扎着说，"我要是一跺脚，整个房子就塌了。"\n胆小先生害怕了，连忙放开了他，还允许他住在地下室里。\n地下室里吃的东西真多，大老鼠吃呀，喝呀，真开心。后来，大老鼠生了一窝小老鼠，小\n老鼠又长成大老鼠……很快，地下室住满了老鼠。\n"不行，不行！"大老鼠冲着胆小先生嚷嚷："这么多老鼠住这么一个小小的地下室，而你一\n个人住那么多房间，太不合理了，得换房子。"\n"换房子？"胆小先生住在地下室，老鼠们住进各个房间，他们在宽大的客厅里唱呀，跳呀，\n在喷香的厨房里喝呀，吃呀，每天都像过节一样。\n"你应该搬出去！"大老鼠又冲着胆小先生嚷嚷，"你干嘛住在地下室？这么好的地下室，你\n配住吗？"\n"什么？"胆小先生气愤得跺了一下右脚，"咚--"老鼠们害怕了，他们个个抱头乱窜，以为地\n震了。\n"哦，原来我是很有力量的！"胆小先生抓起旧扫帚，这儿一扑，那儿一打，这儿一戳，那儿\n一捣，老鼠被打得"吱吱"叫，全逃走了。\n胆小先生后来怎么样了？小朋友能猜到吗？\n故事目标：\n1.感受故事人物幽默的语言和夸张的情节所产生的美。\n2.理解童话内容及"胆小先生"的形象特点。\n3.学习故事中人物的对话，根据自己的想象力表演故事。\n幼儿讨论：大老鼠为什么要与胆小先生换房子？胆小先生为什么答应换房子？房子换成\n后，大老鼠又怎么样了？\n胆小先生是一个什么样的人？胆小先生最后有什么变化？', metadata={'Header 1': '儿童小故事', 'Header 2': '9、胆小先生'}), Document(page_content='有一只小猴跑到山下去，看见人们都穿着鞋走路，感到很好玩。他悄悄地溜到一户人家，\n偷偷地拿了一双鞋跑回山上。他穿上鞋后，很得意地走来走去，伙伴们见了都笑话它。这\n时来了一只凶猛的老虎，猴子们一见纷纷爬上了树。小猴穿着鞋怎么也爬不上树。猴妈妈\n叫他把鞋扔掉。小猴扔掉鞋很快爬上了树，从此再也不乱模仿别人了。\n幼儿讨论：（让孩子想像）\n1.小猴在山下玩时看到什么，它脸上的是什么样的？\n2.小猴怎样溜到别人家里去，它干什么，又怎样想的呢？\n3.小猴怎样跑回山上，它脸上的表情是什么样的，说明了什么？\n4.伙伴们看见小猴穿上了鞋，感到怎样？可能对它说什么？\n5.老虎来了，猴子们心里怎么想？\n6.小猴被妈妈救上了树，脸上的表情是什么样的，说明它心里怎么样的？\n7.小猴最后怎样扔掉了鞋子？小猴的妈妈对它说了些什么？\n8.穿鞋的猴子是什么样的小猴？', metadata={'Header 1': '儿童小故事', 'Header 2': '10、小猴穿鞋'})]

```python
# 执行相似性检索

print("--get_relevant_documents--")
docs = retriever.get_relevant_documents("在想飞的小象故事中，告诉了我们什么样的道理？")
for content in docs:
    print(content)
```

--get_relevant_documents--
page_content='有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"' metadata={'Header 1': '儿童小故事', 'Header 2': '5、想飞的小象'}
page_content='冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。' metadata={'Header 1': '儿童小故事', 'Header 2': '4、老爷爷的帽子'}
page_content='笨狼阿灰经常想歪点子欺负其他小动物，还得意洋洋。这一天，笨狼阿灰又吓唬小公鸡，\n说要吃掉他。小公鸡请求阿灰晚上再来，笨狼同意了。小动物们知道了，一起来帮小公鸡\n想办法。大家在小公鸡的家里布置了一些特别的陷阱。小狗说："小公鸡，这下你可不用害\n怕了。"笨狼阿灰一走进小公鸡家就掉进了陷阱里，大家高兴得拍手称快。\n引导幼儿讨论下列问题：\n1.笨狼阿灰是一只什么样的狼？你喜欢故事中的小公鸡吗？为什么？\n2.如果笨狼阿灰不同意小公鸡的请求，没有等到晚上就来了，公鸡可以想什么办法呢？向\n幼儿提出新的假设条件，帮助幼儿思考新的可能性，然后要求幼儿想象并表达自己的见\n解。' metadata={'Header 1': '儿童小故事', 'Header 2': '2、笨狼阿灰'}
page_content='清晨，小猪去树林里玩。忽然，他发现树边有一个红红的东西，口小底大，摸上去很\n滑："咦，这是什么？好像是个皮袋子，是谁丢的呢？\n小猪手里拿着这东西，嘴里叫着："谁丢了袋子，谁丢了袋子？"\n树上的八哥听见了，"叽叽喳喳"地说："小猪，这不是袋子，是一顶漂亮的红帽子呀！"\n"噢，不是袋子是帽子。"小猪连忙戴在头上，一边走一边叫，"谁丢了帽子，谁丢了帽子？"\n狐狸看见了，嘻嘻地笑起来："小猪，这不是帽子，是一只好看的瓶子呀！"\n"嗯，这瓶子真不错。"小猪采了许多美丽的野花放进瓶子里。\n"谁丢了瓶子？"小猪捧着瓶子走一步，叫一声。\n这时候，来了一只小花狗。他知道了这事，对小猪说："没人丢，没人领，就送给生病的小\n熊吧！"\n小猪和小狗来到了小熊家，把这个没人领的瓶子和花送给小熊。小熊一看，高兴地跳起\n来："哇，这不是瓶子，是我心爱的红靴子呀！"小熊炙得病也好了，三个好朋友嘻嘻哈哈，\n庆祝红靴子找到了主人，回到了家。\n目标：\n1.理解故事内容，学习故事中角色的语言。\n2.理解角色的性格特点，体验乐于助人的情感。\n引导幼儿讨论：你喜欢故事中的小猪吗？为什么？（帮助幼儿总结出小猪的性格特点）\n［憨厚、善良、助人为乐］\n可组织幼儿围绕"我丢了东西以后"为主题进行谈话。例如：你丢过东西吗？心里怎么样？如\n果别人捡到了，还给你，你心里怎么样？如果你捡到了东西会怎么做？\n学习量词的不同用法：一样、一顶、一只、一双。' metadata={'Header 1': '儿童小故事', 'Header 2': '7、小猪和靴子'}

```python
query = "在想飞的小象故事中，告诉了我们什么样的道理？"
similar_docs = db.similarity_search_with_score(query, 4, include_metadata=True)
for content, score in similar_docs:
    print(score, content)
```

0.22830495 page_content='有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"' metadata={'Header 1': '儿童小故事', 'Header 2': '5、想飞的小象'}
0.29543102 page_content='冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。' metadata={'Header 1': '儿童小故事', 'Header 2': '4、老爷爷的帽子'}
0.29576588 page_content='笨狼阿灰经常想歪点子欺负其他小动物，还得意洋洋。这一天，笨狼阿灰又吓唬小公鸡，\n说要吃掉他。小公鸡请求阿灰晚上再来，笨狼同意了。小动物们知道了，一起来帮小公鸡\n想办法。大家在小公鸡的家里布置了一些特别的陷阱。小狗说："小公鸡，这下你可不用害\n怕了。"笨狼阿灰一走进小公鸡家就掉进了陷阱里，大家高兴得拍手称快。\n引导幼儿讨论下列问题：\n1.笨狼阿灰是一只什么样的狼？你喜欢故事中的小公鸡吗？为什么？\n2.如果笨狼阿灰不同意小公鸡的请求，没有等到晚上就来了，公鸡可以想什么办法呢？向\n幼儿提出新的假设条件，帮助幼儿思考新的可能性，然后要求幼儿想象并表达自己的见\n解。' metadata={'Header 1': '儿童小故事', 'Header 2': '2、笨狼阿灰'}
0.3063655 page_content='清晨，小猪去树林里玩。忽然，他发现树边有一个红红的东西，口小底大，摸上去很\n滑："咦，这是什么？好像是个皮袋子，是谁丢的呢？\n小猪手里拿着这东西，嘴里叫着："谁丢了袋子，谁丢了袋子？"\n树上的八哥听见了，"叽叽喳喳"地说："小猪，这不是袋子，是一顶漂亮的红帽子呀！"\n"噢，不是袋子是帽子。"小猪连忙戴在头上，一边走一边叫，"谁丢了帽子，谁丢了帽子？"\n狐狸看见了，嘻嘻地笑起来："小猪，这不是帽子，是一只好看的瓶子呀！"\n"嗯，这瓶子真不错。"小猪采了许多美丽的野花放进瓶子里。\n"谁丢了瓶子？"小猪捧着瓶子走一步，叫一声。\n这时候，来了一只小花狗。他知道了这事，对小猪说："没人丢，没人领，就送给生病的小\n熊吧！"\n小猪和小狗来到了小熊家，把这个没人领的瓶子和花送给小熊。小熊一看，高兴地跳起\n来："哇，这不是瓶子，是我心爱的红靴子呀！"小熊炙得病也好了，三个好朋友嘻嘻哈哈，\n庆祝红靴子找到了主人，回到了家。\n目标：\n1.理解故事内容，学习故事中角色的语言。\n2.理解角色的性格特点，体验乐于助人的情感。\n引导幼儿讨论：你喜欢故事中的小猪吗？为什么？（帮助幼儿总结出小猪的性格特点）\n［憨厚、善良、助人为乐］\n可组织幼儿围绕"我丢了东西以后"为主题进行谈话。例如：你丢过东西吗？心里怎么样？如\n果别人捡到了，还给你，你心里怎么样？如果你捡到了东西会怎么做？\n学习量词的不同用法：一样、一顶、一只、一双。' metadata={'Header 1': '儿童小故事', 'Header 2': '7、小猪和靴子'}

## 检索测试结论

能够找出相似的普通文本

## 1.2 最大边际相关性检索 MMR

```python
# 默认情况下，矢量存储检索器使用相似性搜索。如果基础向量存储支持最大边际相关性搜索，则可以将其指定为搜索类型。
retriever = db.as_retriever(search_type="mmr")
```



```python
# 执行 MMR 检索
docs = retriever.get_relevant_documents("在想飞的小象故事中，告诉了我们什么样的道理？")
docs
```

```
[Document(page_content='有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"', metadata={'Header 1': '儿童小故事', 'Header 2': '5、想飞的小象'}),
 Document(page_content='笨狼阿灰经常想歪点子欺负其他小动物，还得意洋洋。这一天，笨狼阿灰又吓唬小公鸡，\n说要吃掉他。小公鸡请求阿灰晚上再来，笨狼同意了。小动物们知道了，一起来帮小公鸡\n想办法。大家在小公鸡的家里布置了一些特别的陷阱。小狗说："小公鸡，这下你可不用害\n怕了。"笨狼阿灰一走进小公鸡家就掉进了陷阱里，大家高兴得拍手称快。\n引导幼儿讨论下列问题：\n1.笨狼阿灰是一只什么样的狼？你喜欢故事中的小公鸡吗？为什么？\n2.如果笨狼阿灰不同意小公鸡的请求，没有等到晚上就来了，公鸡可以想什么办法呢？向\n幼儿提出新的假设条件，帮助幼儿思考新的可能性，然后要求幼儿想象并表达自己的见\n解。', metadata={'Header 1': '儿童小故事', 'Header 2': '2、笨狼阿灰'}),
 Document(page_content='冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。', metadata={'Header 1': '儿童小故事', 'Header 2': '4、老爷爷的帽子'}),
 Document(page_content='公园里有朵花，真好看，看见小天天，总是笑眯眯的。\n天天问花儿："你叫什么名字？"\n花儿只是笑，不说话。\n天天伸出小手，要采这朵花。\n外公摆摆手说："天天别采！你不采她，花儿总是对你笑，你一采下来，花儿就哭了。"\n天天不想看到小花对他哭，天天没有采。\n天天回家以后，告诉外婆："公园里有一朵花，很乖很乖，对他一直笑，一直笑。"\n外婆说："天天也很乖，你也是一朵爱笑的小花。"\n故事目标：\n1.知道微笑是一种美。\n2.懂得要爱护花。（周末带孩子去公园看花）\n可设置一些问题让幼儿讨论：\n1.小天天和花儿都有一个什么特点让人喜欢？\n2.小天天为什么一直没有摘公园里的那朵花？\n3.外婆为什么说："天天也是一朵爱笑的小花？"\n让幼儿明白：微笑会让大家喜欢，爱护花的孩子更让人喜欢。', metadata={'Header 1': '儿童小故事', 'Header 2': '1、爱笑的小花'})]
```

MMR 检索，同时要求考虑相关性和多样性。在这里可以看出，MMR 和 相似性检索，基本能保证选中最相关的一个文档



```python
# 执行相似性检索
retriever2 = db.as_retriever(
    search_type="similarity", search_kwargs={"k": 4}
)

print("--get_relevant_documents--") 
docs = retriever2.get_relevant_documents("在想飞的小象故事中，告诉了我们什么样的道理？")
for content in docs:
    print(content)

print("--max_marginal_relevance_search--")
docs = db.max_marginal_relevance_search("在想飞的小象故事中，告诉了我们什么样的道理？")
for content in docs:
    print(content)

print("--similarity_search_with_score--")
docs = db.similarity_search_with_score("在想飞的小象故事中，告诉了我们什么样的道理？")
for content, score in docs:
    print(score, content)

print("--similarity_search_with_relevance_scores--")
docs = db.similarity_search_with_relevance_scores("在想飞的小象故事中，告诉了我们什么样的道理？")
for content, score in docs:
    print(score, content)
```

## 1.3 相似性分数阈值检索

```python
retriever = db.as_retriever(
    search_type="similarity_score_threshold", search_kwargs={"score_threshold": 0.5}
)
```



```python
docs = retriever.get_relevant_documents("在想飞的小象故事中，告诉了我们什么样的道理？")
docs
```

Out[ ]:

```
[Document(page_content='有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"', metadata={'Header 1': '儿童小故事', 'Header 2': '5、想飞的小象'}),
 Document(page_content='冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。', metadata={'Header 1': '儿童小故事', 'Header 2': '4、老爷爷的帽子'}),
 Document(page_content='笨狼阿灰经常想歪点子欺负其他小动物，还得意洋洋。这一天，笨狼阿灰又吓唬小公鸡，\n说要吃掉他。小公鸡请求阿灰晚上再来，笨狼同意了。小动物们知道了，一起来帮小公鸡\n想办法。大家在小公鸡的家里布置了一些特别的陷阱。小狗说："小公鸡，这下你可不用害\n怕了。"笨狼阿灰一走进小公鸡家就掉进了陷阱里，大家高兴得拍手称快。\n引导幼儿讨论下列问题：\n1.笨狼阿灰是一只什么样的狼？你喜欢故事中的小公鸡吗？为什么？\n2.如果笨狼阿灰不同意小公鸡的请求，没有等到晚上就来了，公鸡可以想什么办法呢？向\n幼儿提出新的假设条件，帮助幼儿思考新的可能性，然后要求幼儿想象并表达自己的见\n解。', metadata={'Header 1': '儿童小故事', 'Header 2': '2、笨狼阿灰'}),
 Document(page_content='清晨，小猪去树林里玩。忽然，他发现树边有一个红红的东西，口小底大，摸上去很\n滑："咦，这是什么？好像是个皮袋子，是谁丢的呢？\n小猪手里拿着这东西，嘴里叫着："谁丢了袋子，谁丢了袋子？"\n树上的八哥听见了，"叽叽喳喳"地说："小猪，这不是袋子，是一顶漂亮的红帽子呀！"\n"噢，不是袋子是帽子。"小猪连忙戴在头上，一边走一边叫，"谁丢了帽子，谁丢了帽子？"\n狐狸看见了，嘻嘻地笑起来："小猪，这不是帽子，是一只好看的瓶子呀！"\n"嗯，这瓶子真不错。"小猪采了许多美丽的野花放进瓶子里。\n"谁丢了瓶子？"小猪捧着瓶子走一步，叫一声。\n这时候，来了一只小花狗。他知道了这事，对小猪说："没人丢，没人领，就送给生病的小\n熊吧！"\n小猪和小狗来到了小熊家，把这个没人领的瓶子和花送给小熊。小熊一看，高兴地跳起\n来："哇，这不是瓶子，是我心爱的红靴子呀！"小熊炙得病也好了，三个好朋友嘻嘻哈哈，\n庆祝红靴子找到了主人，回到了家。\n目标：\n1.理解故事内容，学习故事中角色的语言。\n2.理解角色的性格特点，体验乐于助人的情感。\n引导幼儿讨论：你喜欢故事中的小猪吗？为什么？（帮助幼儿总结出小猪的性格特点）\n［憨厚、善良、助人为乐］\n可组织幼儿围绕"我丢了东西以后"为主题进行谈话。例如：你丢过东西吗？心里怎么样？如\n果别人捡到了，还给你，你心里怎么样？如果你捡到了东西会怎么做？\n学习量词的不同用法：一样、一顶、一只、一双。', metadata={'Header 1': '儿童小故事', 'Header 2': '7、小猪和靴子'})]
```

## 1.4 指定 top k

```python
retriever = db.as_retriever(
    search_type="similarity_score_threshold", search_kwargs={"score_threshold": 0.5, "k": 2}
)
```



```
docs = retriever.get_relevant_documents("在想飞的小象故事中，告诉了我们什么样的道理？")
docs
```

Out[ ]:

```
[Document(page_content='有一只小象，刚刚生下来。第一天，他看到了许多小动物。到了第二天，他认识了许多花\n儿、草儿。第三天呢，妈妈带他到河边，他看见了河水和高山。小象说："世界真大呀！"这\n时，一只小鸟在天空中飞来飞去。\n小象想："要是我也会飞，可以看更多的东西，多好呀！\n小象爬到树上学飞，"哎哟"一声，摔了一个大跟头。\n蛇看见了说："小象，我们有自己的本事。我不会飞，可是我会在树上睡觉。"\n狮子说："我也不会飞，可是，我能跳过宽宽的大河。"\n老虎说："我不会飞，可是，我会游泳。"\n爸爸妈妈对小象说："我们大象力气大，这是小鸟不能比的。"\n小象明白了，他跟着爸爸妈妈运木头。他用长鼻子一钩，大木头就搬走了。大家都喜欢\n他。小象说："我是小象真幸福。"\n故事目标：\n1.专心听故事，记住故事中的各种角色，对有生活哲理的趣味童话感兴趣。\n2.学习动词：爬、摔、钩、搬。\n3.学说完整句："我不会×，可是我会×××。"\n4.知道每一个人都有自己的本事，别小看自己。\n与幼儿讨论：\n1.小鸟、蛇、狮子、老虎、大象中，哪一种动物会飞？哪一种动物会爬？哪一种会游泳？\n2.小象从树上摔下来后，谁对他说了什么？小象一开始为什么总是羡慕别人？他是怎样变\n得看得起自己，而且感到"我是小象真幸福"的？学习并运用句式"我不会×，可是我会\n×××。"\n学习完整句："我不会×，可是我会×××。"\n请幼儿说一说："我也能做×××事，我是妈妈的孩子真幸福。"', metadata={'Header 1': '儿童小故事', 'Header 2': '5、想飞的小象'}),
 Document(page_content='冬天到了，北风呼呼地吹，天气很冷。有一只小鸟真可怜，它在树枝上冷得直发抖。\n一位老爷爷走来，看见了小鸟，心想："这只小鸟多可怜呀，这么冷的天，它一定会冻死\n的。"小鸟对老爷爷说："风把我们的窝给走了，我们没有家了。"老爷爷说："别着急，我来\n帮你们想办法。"老爷爷就用自己的帽子给小鸟做鸟窝，帽子真暖和。\n小鸟想到树林里还有许多怕冷的小鸟，就把它们都叫来，一起飞进了老爷爷的帽子。它们\n非常感谢老爷爷。以后老爷爷也天天来看小鸟，小鸟们每次都唱歌给老爷爷听。\n有一天老爷爷没有来，原来他病了。小鸟想："一定是爷爷把帽子给了我们，自己着凉生病\n了，我们赶快给老爷爷做顶帽子吧。小鸟们就用自己的羽毛做了一顶帖子送给老爷爷。老\n爷爷非常感谢小鸟，他的病很快就好了。\n这是一篇社会性教育童话故事，适用于中班年龄的孩子。\n《老爷爷的帽子》这则童话以"老爷爷关心小鸟，小鸟关心老爷爷，"这一主题，将我们还入\n了一个温馨、和谐、充满爱的世界。现在的独生子女大多只知道满足自己的需要，而不会\n考虑别人的情绪和感受，缺乏同情心，不懂得关心、帮助别人。而未来社会需要幼儿从\n小"学会生活，学会关心"。\n故事目标：\n1.引导幼儿初步理解他人的需要，学会关心、帮助他人。\n2.激发幼儿的同情心，获得被人关心和帮助他人的内心感受。\n3.鼓励幼儿大胆表达自己的见解，发展口语表达能力和交往能力。', metadata={'Header 1': '儿童小故事', 'Header 2': '4、老爷爷的帽子'})]
```

# Test 02 在精心设计的精确划分下，数据文本查找测试

In [ ]:

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("./data/log_30.txt")
documents = loader.load()
print(documents)
```

In [ ]:

```python
# 查看文档的字数

print(len(documents[0].page_content))
```

19883

```python
from langchain_text_splitters import CharacterTextSplitter

text_splitter = CharacterTextSplitter(
    separator="\n\n", # 分隔符
    chunk_size=1000,
    chunk_overlap=200,
    length_function=len,
    is_separator_regex=False,
)
```

In [ ]:

```
!pwd
/root/AAAMyProjects/citylearn-phase-2-submission-version1.7
```

In [ ]:

```python
# # 为了更准确地对文档进行分块，对文档进行了处理。

# # 指定要读取的文件路径
# input_file = "./data/log_30.txt"

# # 指定要写入的文件路径
# output_file = "./data/log_302.txt"

# # 打开要读取的文件
# with open(input_file, "r", encoding="utf-8") as file:
#     # 读取文件内容
#     content = file.readlines()

# print(content[2])

# # 处理内容,每两行添加一个回车符
# processed_content = []
# for i in range(0, len(content), 2):
#     processed_content.append(content[i])
#     if i + 1 < len(content):
#         processed_content.append(content[i + 1] + "\n")

# # 打开要写入的文件
# with open(output_file, "w", encoding="utf-8") as file:
#     # 将处理后的内容写入文件
#     file.writelines(processed_content)

# print("处理完成!")
```

In [ ]:

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("./data/log_302.txt")
documents = loader.load()
print(documents)
```

In [ ]:

```python
from langchain_text_splitters import CharacterTextSplitter

text_splitter = CharacterTextSplitter(
    separator="\n\n",
    chunk_size=1000,
    chunk_overlap=200,
    length_function=len,
    is_separator_regex=False,
)
```

In [ ]:

```python
split_docs = text_splitter.split_documents(documents)
split_docs
```



In [ ]:

```python
# 向量化文档并生成检索器
from langchain.vectorstores import FAISS
from langchain_openai import ChatOpenAI, OpenAIEmbeddings

embeddings = OpenAIEmbeddings(
    openai_api_base="https://api.nextapi.fun/v1", 
    openai_api_key="ak-5q53TviefzOYW8xW2F0gFtS20aO2gT288sPWSD92YQpjqmSJ",
)

completed_db = FAISS.from_documents(split_docs, embeddings)
```

## 2.1 数据相似性检索的 search_type

在LangChain中, `search_type`还可以设置为以下几种值:

1. `"similarity"`(默认值): 此搜索类型使用标准的相似性搜索,并返回与查询最相似的文档。
2. `"max_marginal_relevance_score"` or `"mmr"`: 这是你在示例代码中看到的搜索类型。它在相似性搜索的基础上应用了"最大边际相关性"(MMR)算法,以提高结果的多样性和新颖性。
3. `"similarity_score_threshold"`: 此搜索类型返回相似性分数大于或等于指定阈值的所有文档,阈值由`search_kwargs["score_threshold"]`指定。

如果你更关注结果的多样性,可以使用`mmr`。

如果你有特定的相似性分数阈值,可以使用`similarity_score_threshold`。

下面我们试一试各种 search_type：

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="similarity", search_kwargs={"k": 3}
)

# 第7次 observations
query7 = """
[5, 8, 26.94, 38.978542, 33.50567, 27.364582, 90.91, 96.567314, 0.0, 189.49379, 268.13, 916.1268, 0.0, 401.81763, 0.41118348, 22.332556, 0.40251273, 0.2191261, 0.0, 0.12776601, 0.5025906, 0.02915, 0.02915, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.333334, 0, 24.848763, 0.4547772, 0.10956305, 0.23408309, 0.12776601, 0.31357068, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.8164316, 0.2191261, 0.0, 0.13153236, 0.859486, 1.0092591, 0.0, 1.0, 23.333334, 0]
"""

print("--Retriever.get_relevant_documents")
# 第一次检索 
docs = AgentRetriever.get_relevant_documents(query7)
for content in docs:
    print(content)

print("--completed_db.similarity_search")
# 第二次检索
docs = completed_db.similarity_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.similarity_search_with_score")
# 第三次检索
docs = completed_db.similarity_search_with_score(query7,3)
for content, score in docs:
    print(score, content)

print("--completed_db.max_marginal_relevance_search")
# 第四次检索
docs = completed_db.max_marginal_relevance_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.max_marginal_relevance_search")
# 第五次检索
docs = completed_db._similarity_search_with_relevance_scores(query7,3)
for content, score in docs:
    print(score, content)

```

都成功找到了最相关的文档

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="similarity_score_threshold", search_kwargs={"score_threshold":0.2, "k": 5}
)

print("search_type=similarity_score_threshold")

# 使用 第x次 observations
query7 = """
[5, 8, 26.94, 38.978542, 33.50567, 27.364582, 90.91, 96.567314, 0.0, 189.49379, 268.13, 916.1268, 0.0, 401.81763, 0.41118348, 22.332556, 0.40251273, 0.2191261, 0.0, 0.12776601, 0.5025906, 0.02915, 0.02915, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.333334, 0, 24.848763, 0.4547772, 0.10956305, 0.23408309, 0.12776601, 0.31357068, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.8164316, 0.2191261, 0.0, 0.13153236, 0.859486, 1.0092591, 0.0, 1.0, 23.333334, 0]
"""

query8 = """
[5, 9, 29.3, 39.550983, 29.976658, 30.812954, 218.81, 122.01821, 0.0, 147.05728, 197.38, 998.7861, 0.0, 624.6431, 0.4328323, 22.771797, 0.45280996, 0.53274006, 0.0, 0.119843155, 4.623585, 0.02915, 0.02915, 0.02915, 0.02893, 4.0250163, 3.3150163, 2.0, 22.777779, 0, 24.99118, 0.62060094, 0.26637003, 0.0, 0.119843155, 2.4750144, 3.8661427, 1.3129643, 1.0, 25.0, 0, 23.333536, 1.0114818, 0.53274006, 0.0, 0.12388907, 2.1640027, 2.3608716, 0.86923575, 1.0, 23.333334, 0] 
"""

query21 = """
observations: [5, 22, 29.6, 24.212109, 32.68576, 32.217403, 0.0, 0.0, 146.93661, 0.0, 0.0, 0.0, 600.10016, 0.0, 0.44714594, 28.585644, 0.4542192, 0.0, 0.0, 0.052141797, 1.2950938, 0.02915, 0.02893, 0.02893, 0.02893, 1.2251319, 0.4529954, 2.0, 24.444445, 0, 27.282635, 0.3876185, 0.0, 0.11386733, 0.052141797, 0.95024264, 1.4960169, 0.0, 1.0, 23.38889, 0, 26.512836, 1.190019, 0.0, 0.0, 0.05689025, 2.429144, 1.4879465, 0.69876826, 2.0, 24.444445, 0] 
"""

print("--------")
docs = AgentRetriever.get_relevant_documents("query7")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第7次 observations")

print("--------")
docs = AgentRetriever.get_relevant_documents("query8")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第8次 observations")

print("--------")
docs = AgentRetriever.get_relevant_documents("query21")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第21次 observations")
```

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="mmr", search_kwargs={"score_threshold":0.2, "k": 5}
)

print("search_type=mmr")

# 使用 第x次 observations
query7 = """
[5, 8, 26.94, 38.978542, 33.50567, 27.364582, 90.91, 96.567314, 0.0, 189.49379, 268.13, 916.1268, 0.0, 401.81763, 0.41118348, 22.332556, 0.40251273, 0.2191261, 0.0, 0.12776601, 0.5025906, 0.02915, 0.02915, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.333334, 0, 24.848763, 0.4547772, 0.10956305, 0.23408309, 0.12776601, 0.31357068, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.8164316, 0.2191261, 0.0, 0.13153236, 0.859486, 1.0092591, 0.0, 1.0, 23.333334, 0]
"""

query8 = """
[5, 9, 29.3, 39.550983, 29.976658, 30.812954, 218.81, 122.01821, 0.0, 147.05728, 197.38, 998.7861, 0.0, 624.6431, 0.4328323, 22.771797, 0.45280996, 0.53274006, 0.0, 0.119843155, 4.623585, 0.02915, 0.02915, 0.02915, 0.02893, 4.0250163, 3.3150163, 2.0, 22.777779, 0, 24.99118, 0.62060094, 0.26637003, 0.0, 0.119843155, 2.4750144, 3.8661427, 1.3129643, 1.0, 25.0, 0, 23.333536, 1.0114818, 0.53274006, 0.0, 0.12388907, 2.1640027, 2.3608716, 0.86923575, 1.0, 23.333334, 0] 
"""

query21 = """
observations: [5, 22, 29.6, 24.212109, 32.68576, 32.217403, 0.0, 0.0, 146.93661, 0.0, 0.0, 0.0, 600.10016, 0.0, 0.44714594, 28.585644, 0.4542192, 0.0, 0.0, 0.052141797, 1.2950938, 0.02915, 0.02893, 0.02893, 0.02893, 1.2251319, 0.4529954, 2.0, 24.444445, 0, 27.282635, 0.3876185, 0.0, 0.11386733, 0.052141797, 0.95024264, 1.4960169, 0.0, 1.0, 23.38889, 0, 26.512836, 1.190019, 0.0, 0.0, 0.05689025, 2.429144, 1.4879465, 0.69876826, 2.0, 24.444445, 0] 
"""

print("--------")
docs = AgentRetriever.get_relevant_documents("query7")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第7次 observations")

print("--------")
docs = AgentRetriever.get_relevant_documents("query8")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第8次 observations")

print("--------")
docs = AgentRetriever.get_relevant_documents("query21")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第21次 observations")
```

# Test 03 在粗粒度划分下，查找测试。

In [ ]:

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("./data/log_30.txt")
documents = loader.load()
print(documents)

# 查看文档的字数
print(f"文档字符长度：{len(documents[0].page_content)}")
```

In [ ]:

```python
from langchain_text_splitters import CharacterTextSplitter

# 加大划分粒度
text_splitter = CharacterTextSplitter(
    separator="\n",
    chunk_size=6000,
    chunk_overlap=300,
    length_function=len,
    is_separator_regex=False,
)
```

In [ ]:

```python
split_docs = text_splitter.split_documents(documents)
for doc in split_docs:
    print(doc)
```

In [ ]:

```python
# 向量化文档并生成检索器
from langchain.vectorstores import FAISS
from langchain_openai import ChatOpenAI, OpenAIEmbeddings

embeddings = OpenAIEmbeddings(
    openai_api_base="https://api.nextapi.fun/v1", 
    openai_api_key="ak-5q53TviefzOYW8xW2F0gFtS20aO2gT288sPWSD92YQpjqmSJ",
)

completed_db = FAISS.from_documents(split_docs, embeddings)
```

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="similarity", search_kwargs={"k": 3}
)

# 第7次 observations
query7 = """
[5, 8, 26.94, 38.978542, 33.50567, 27.364582, 90.91, 96.567314, 0.0, 189.49379, 268.13, 916.1268, 0.0, 401.81763, 0.41118348, 22.332556, 0.40251273, 0.2191261, 0.0, 0.12776601, 0.5025906, 0.02915, 0.02915, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.333334, 0, 24.848763, 0.4547772, 0.10956305, 0.23408309, 0.12776601, 0.31357068, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.8164316, 0.2191261, 0.0, 0.13153236, 0.859486, 1.0092591, 0.0, 1.0, 23.333334, 0]
"""

print("--Retriever.get_relevant_documents")
# 第一次检索 
docs = AgentRetriever.get_relevant_documents(query7)
for content in docs:
    print(content)

print("--completed_db.similarity_search")
# 第二次检索
docs = completed_db.similarity_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.similarity_search_with_score")
# 第三次检索
docs = completed_db.similarity_search_with_score(query7,3)
for content, score in docs:
    print(score, content)

print("--completed_db.max_marginal_relevance_search")
# 第四次检索
docs = completed_db.max_marginal_relevance_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.max_marginal_relevance_search")
# 第五次检索
docs = completed_db._similarity_search_with_relevance_scores(query7,3)
for content, score in docs:
    print(score, content)
```

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="mmr", search_kwargs={"k": 3}
)

# 第7次 observations
query7 = """
[5, 8, 26.94, 38.978542, 33.50567, 27.364582, 90.91, 96.567314, 0.0, 189.49379, 268.13, 916.1268, 0.0, 401.81763, 0.41118348, 22.332556, 0.40251273, 0.2191261, 0.0, 0.12776601, 0.5025906, 0.02915, 0.02915, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.333334, 0, 24.848763, 0.4547772, 0.10956305, 0.23408309, 0.12776601, 0.31357068, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.8164316, 0.2191261, 0.0, 0.13153236, 0.859486, 1.0092591, 0.0, 1.0, 23.333334, 0]
"""
print("使用第7次 observations 进行查找")

print("--Retriever.get_relevant_documents")
# 第一次检索 
docs = AgentRetriever.get_relevant_documents(query7)
for content in docs:
    print(content)

print("--completed_db.similarity_search")
# 第二次检索
docs = completed_db.similarity_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.similarity_search_with_score")
# 第三次检索
docs = completed_db.similarity_search_with_score(query7,3)
for content, score in docs:
    print(score, content)

print("--completed_db.max_marginal_relevance_search")
# 第四次检索
docs = completed_db.max_marginal_relevance_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.max_marginal_relevance_search")
# 第五次检索
docs = completed_db._similarity_search_with_relevance_scores(query7,3)
for content, score in docs:
    print(score, content)
```

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="mmr", search_kwargs={"k": 3}
)

# 第7次 observations
query29 = """
observations: [6, 6, 24.69, 36.866394, 39.30375, 26.774897, 0.0, 144.76385, 64.603226, 0.0, 0.0, 831.3776, 463.5365, 0.0, 0.36689994, 24.319656, 1.3658526, 0.0, 0.0, 0.031244187, 1.8854057, 0.02893, 0.02893, 0.02893, 0.02893, 2.250574, 0.0, 3.0, 22.222221, 0, 22.8683, 0.23087537, 0.0, 0.3237664, 0.031244187, 0.70285803, 1.7180178, 0.0, 1.0, 24.444445, 0, 23.10997, 0.4998095, 0.0, 0.015846133, 0.035240397, 1.0742072, 2.0972624, 0.0, 2.0, 23.944445, 0] 
"""
print("使用第29次 observations 进行查找")

print("--Retriever.get_relevant_documents")
# 第一次检索 
docs = AgentRetriever.get_relevant_documents(query29)
for content in docs:
    print(content)

print("--completed_db.similarity_search")
# 第二次检索
docs = completed_db.similarity_search(query29,3)
for content in docs:
    print(content)

print("--completed_db.similarity_search_with_score")
# 第三次检索
docs = completed_db.similarity_search_with_score(query29,3)
for content, score in docs:
    print(score, content)

print("--completed_db.max_marginal_relevance_search")
# 第四次检索
docs = completed_db.max_marginal_relevance_search(query29,3)
for content in docs:
    print(content)

print("--completed_db.max_marginal_relevance_search")
# 第五次检索
docs = completed_db._similarity_search_with_relevance_scores(query29,3)
for content, score in docs:
    print(score, content)

```

### 可以看到，在粗粒度划分下，有一定概率，无法第一个找到最相关的文档

# Test 04 轻微改变初始值查找（精确划分下）

以上查找是使用文档中原有的内容，即查找内容与原始文档内容一致。下面测试轻微改变被查找的值，看是否还能被正确查找

In [ ]:

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("./data/log_302.txt")
documents = loader.load()
print(documents)
```

In [ ]:

```python
from langchain_text_splitters import CharacterTextSplitter

text_splitter = CharacterTextSplitter(
    separator="\n\n",
    chunk_size=1000,
    chunk_overlap=200,
    length_function=len,
    is_separator_regex=False,
)

split_docs = text_splitter.split_documents(documents)
for doc in split_docs:
    print(doc)
```

In [ ]:

```python
# 向量化文档并生成检索器
from langchain.vectorstores import FAISS
from langchain_openai import ChatOpenAI, OpenAIEmbeddings

embeddings = OpenAIEmbeddings(
    openai_api_base="https://api.nextapi.fun/v1", 
    openai_api_key="ak-5q53TviefzOYW8xW2F0gFtS20aO2gT288sPWSD92YQpjqmSJ",
)

completed_db = FAISS.from_documents(split_docs, embeddings)
```

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="similarity", search_kwargs={"k": 3}
)

# 第7次 observations
print("使用第7次 observations")
query7 = """
[5, 8, 26.94, 39.078542, 32.90567, 27.304582, 90.71, 96.567314, 0.0, 189.47379, 268.13, 915.1268, 0.0, 400.81763, 0.41118348, 22.332556, 0.40251273, 0.2191261, 0.0, 0.12676601, 0.5005906, 0.02915, 0.02915, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.33334, 0, 24.84863, 0.454772, 0.1095305, 0.23408309, 0.1277601, 0.3135708, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.816436, 0.219261, 0.0, 0.1315236, 0.85986, 1.0093591, 0.0, 1.0, 23.33334, 0]
"""

print("--Retriever.get_relevant_documents")
# 第一次检索 
docs = AgentRetriever.get_relevant_documents(query7)
for content in docs:
    print(content)

print("--completed_db.similarity_search")
# 第二次检索
docs = completed_db.similarity_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.similarity_search_with_score")
# 第三次检索
docs = completed_db.similarity_search_with_score(query7,3)
for content, score in docs:
    print(score, content)

print("--completed_db.max_marginal_relevance_search")
# 第四次检索
docs = completed_db.max_marginal_relevance_search(query7,3)
for content in docs:
    print(content)

print("--completed_db.max_marginal_relevance_search")
# 第五次检索
docs = completed_db._similarity_search_with_relevance_scores(query7,3)
for content, score in docs:
    print(score, content)
```

轻微改变数据值后，直接找不出来了。

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="mmr", search_kwargs={"score_threshold":0.2, "k": 5}
)

print("search_type=mmr")

# 使用 第x次 observations
query7 = """
[5, 8, 26.94, 38.97852, 33.50567, 27.36452, 90.91, 96.56314, 0.0, 189.4379, 268.13, 916.1268, 0.0, 401.81763, 0.41118348, 22.332556, 0.40251273, 0.219161, 0.0, 0.127661, 0.5025906, 0.0295, 0.03015, 0.02915, 0.02893, 1.319662, 0.0, 2.0, 22.333334, 0, 24.848763, 0.4547772, 0.10956305, 0.23408309, 0.12776601, 0.31357068, 0.0, 0.0, 1.0, 25.0, 0, 23.349218, 0.8164316, 0.219161, 0.0, 0.1315236, 0.85986, 1.009251, 0.0, 1.0, 23.33334, 0]
"""

query8 = """
[5, 9, 29.3, 39.550983, 29.976658, 30.812954, 218.81, 122.01821, 0.0, 147.05728, 197.38, 998.7861, 0.0, 624.6431, 0.4328323, 22.771797, 0.45280996, 0.53274006, 0.0, 0.119843155, 4.623585, 0.02915, 0.02915, 0.02915, 0.02893, 4.0250163, 3.315063, 2.0, 22.77779, 0, 24.9918, 0.6206094, 0.2663703, 0.0, 0.119843155, 2.475144, 3.866427, 1.312643, 1.0, 25.0, 0, 23.33356, 1.011418, 0.5327406, 0.0, 0.1238807, 2.164027, 2.3608716, 0.86923575, 1.0, 23.333334, 0] 
"""

query21 = """
observations: [5, 22, 29.6, 24.212119, 32.68576, 32.207403, 0.0, 0.0, 146.93601, 0.0, 0.0, 0.0, 600.1006, 0.0, 0.4474594, 28.585644, 0.4542192, 0.0, 0.0, 0.052141797, 1.2950938, 0.02915, 0.02893, 0.02893, 0.02893, 1.2251319, 0.452994, 2.0, 24.44445, 0, 27.282635, 0.387615, 0.0, 0.1138733, 0.05214797, 0.9502264, 1.496069, 0.0, 1.0, 23.38889, 0, 26.51236, 1.19019, 0.0, 0.0, 0.05689025, 2.429144, 1.4879465, 0.6987686, 2.0, 24.444445, 0] 
"""

print("--------")
docs = AgentRetriever.get_relevant_documents("query7")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第7次 observations")

print("--------")
docs = AgentRetriever.get_relevant_documents("query8")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第8次 observations")

print("--------")
docs = AgentRetriever.get_relevant_documents("query21")
for content in docs:
    print(content)

print("success，成功第一个找到想要的第21次 observations")
```

可以说，基本上一个也找不出来了

# Test 05 趋势匹配测试

In [ ]:

```python
with open("./LongText2.txt", "w") as file:
    for i in range(10):
        file.write(str(i+1)*6)
    file.write("\n\n")   

    for i in range(10,0,-1):
        file.write(str(i)*6)
    file.write("\n\n")   

    for i in range(10):
        file.write(str(i)*66)
        file.write("\n\n")         

    for i in range(10):
        file.write(str(i)*4)
    file.write("\n\n")   

    for i in range(10):
        file.write(str(i)*5)
    file.write("\n\n")       

    for i in range(10):
        file.write(str(i)*7)
    file.write("\n\n")  

print("down")
down
```

In [ ]:

```python
from langchain_community.document_loaders import TextLoader

loader = TextLoader("./LongText2.txt")
documents = loader.load()
print(documents)
```

In [ ]:

```python
from langchain_text_splitters import CharacterTextSplitter

text_splitter = CharacterTextSplitter(
    separator="\n\n",
    chunk_size=100,
    chunk_overlap=0,
    length_function=len,
    is_separator_regex=False,
)
```

In [ ]:

```
split_docs = text_splitter.split_documents(documents)
for doc in split_docs:
    print(doc)
page_content='111111222222333333444444555555666666777777888888999999101010101010' metadata={'source': './LongText2.txt'}
page_content='101010101010999999888888777777666666555555444444333333222222111111' metadata={'source': './LongText2.txt'}
page_content='000000000000000000000000000000000000000000000000000000000000000000' metadata={'source': './LongText2.txt'}
page_content='111111111111111111111111111111111111111111111111111111111111111111' metadata={'source': './LongText2.txt'}
page_content='222222222222222222222222222222222222222222222222222222222222222222' metadata={'source': './LongText2.txt'}
page_content='333333333333333333333333333333333333333333333333333333333333333333' metadata={'source': './LongText2.txt'}
page_content='444444444444444444444444444444444444444444444444444444444444444444' metadata={'source': './LongText2.txt'}
page_content='555555555555555555555555555555555555555555555555555555555555555555' metadata={'source': './LongText2.txt'}
page_content='666666666666666666666666666666666666666666666666666666666666666666' metadata={'source': './LongText2.txt'}
page_content='777777777777777777777777777777777777777777777777777777777777777777' metadata={'source': './LongText2.txt'}
page_content='888888888888888888888888888888888888888888888888888888888888888888' metadata={'source': './LongText2.txt'}
page_content='999999999999999999999999999999999999999999999999999999999999999999' metadata={'source': './LongText2.txt'}
page_content='0000111122223333444455556666777788889999\n\n00000111112222233333444445555566666777778888899999' metadata={'source': './LongText2.txt'}
page_content='0000000111111122222223333333444444455555556666666777777788888889999999' metadata={'source': './LongText2.txt'}
```

In [ ]:

```
# 向量化文档并生成检索器
from langchain.vectorstores import FAISS
from langchain_openai import ChatOpenAI, OpenAIEmbeddings

embeddings = OpenAIEmbeddings(
    openai_api_base="https://api.nextapi.fun/v1", 
    openai_api_key="ak-5q53TviefzOYW8xW2F0gFtS20aO2gT288sPWSD92YQpjqmSJ",
)

completed_db = FAISS.from_documents(split_docs, embeddings)
```

In [ ]:

```python
# 生成检索器
AgentRetriever = completed_db.as_retriever(
    search_type="similarity", search_kwargs={"k": 6}
)

print("查看7766554433， 期望匹配101010101010999999888888777777666666555555444444333333222222111111")
query = """
887766554433
"""

print("--Retriever.get_relevant_documents")
# 第一次检索 
docs = AgentRetriever.get_relevant_documents(query)
for content in docs:
    print(content)

print("--completed_db.similarity_search")
# 第二次检索
docs = completed_db.similarity_search(query,6)
for content in docs:
    print(content)

print("--completed_db.similarity_search_with_score")
# 第三次检索
docs = completed_db.similarity_search_with_score(query,6)
for content, score in docs:
    print(score, content)

print("--completed_db.max_marginal_relevance_search")
# 第四次检索
docs = completed_db.max_marginal_relevance_search(query,6)
for content in docs:
    print(content)

print("--completed_db.max_marginal_relevance_search")
# 第五次检索
docs = completed_db._similarity_search_with_relevance_scores(query,6)
for content, score in docs:
    print(score, content)

```

查看7766554433， 期望匹配101010101010999999888888777777666666555555444444333333222222111111
--Retriever.get_relevant_documents
page_content='0000000111111122222223333333444444455555556666666777777788888889999999' metadata={'source': './LongText2.txt'}
page_content='0000111122223333444455556666777788889999\n\n00000111112222233333444445555566666777778888899999' metadata={'source': './LongText2.txt'}
page_content='000000000000000000000000000000000000000000000000000000000000000000' metadata={'source': './LongText2.txt'}
page_content='111111222222333333444444555555666666777777888888999999101010101010' metadata={'source': './LongText2.txt'}
page_content='888888888888888888888888888888888888888888888888888888888888888888' metadata={'source': './LongText2.txt'}
page_content='101010101010999999888888777777666666555555444444333333222222111111' metadata={'source': './LongText2.txt'}
--completed_db.similarity_search
page_content='0000000111111122222223333333444444455555556666666777777788888889999999' metadata={'source': './LongText2.txt'}
page_content='0000111122223333444455556666777788889999\n\n00000111112222233333444445555566666777778888899999' metadata={'source': './LongText2.txt'}
page_content='000000000000000000000000000000000000000000000000000000000000000000' metadata={'source': './LongText2.txt'}
page_content='111111222222333333444444555555666666777777888888999999101010101010' metadata={'source': './LongText2.txt'}
page_content='888888888888888888888888888888888888888888888888888888888888888888' metadata={'source': './LongText2.txt'}
page_content='101010101010999999888888777777666666555555444444333333222222111111' metadata={'source': './LongText2.txt'}
--completed_db.similarity_search_with_score
0.26169932 page_content='0000000111111122222223333333444444455555556666666777777788888889999999' metadata={'source': './LongText2.txt'}
0.27124947 page_content='0000111122223333444455556666777788889999\n\n00000111112222233333444445555566666777778888899999' metadata={'source': './LongText2.txt'}
0.2966954 page_content='000000000000000000000000000000000000000000000000000000000000000000' metadata={'source': './LongText2.txt'}
0.3014494 page_content='111111222222333333444444555555666666777777888888999999101010101010' metadata={'source': './LongText2.txt'}
0.3041361 page_content='888888888888888888888888888888888888888888888888888888888888888888' metadata={'source': './LongText2.txt'}
0.30611432 page_content='101010101010999999888888777777666666555555444444333333222222111111' metadata={'source': './LongText2.txt'}
--completed_db.max_marginal_relevance_search
page_content='0000000111111122222223333333444444455555556666666777777788888889999999' metadata={'source': './LongText2.txt'}
page_content='888888888888888888888888888888888888888888888888888888888888888888' metadata={'source': './LongText2.txt'}
page_content='000000000000000000000000000000000000000000000000000000000000000000' metadata={'source': './LongText2.txt'}
page_content='777777777777777777777777777777777777777777777777777777777777777777' metadata={'source': './LongText2.txt'}
page_content='101010101010999999888888777777666666555555444444333333222222111111' metadata={'source': './LongText2.txt'}
page_content='0000111122223333444455556666777788889999\n\n00000111112222233333444445555566666777778888899999' metadata={'source': './LongText2.txt'}
--completed_db.max_marginal_relevance_search
0.8149506369839479 page_content='0000000111111122222223333333444444455555556666666777777788888889999999' metadata={'source': './LongText2.txt'}
0.8081976581812899 page_content='0000111122223333444455556666777788889999\n\n00000111112222233333444445555566666777778888899999' metadata={'source': './LongText2.txt'}
0.790204662789807 page_content='000000000000000000000000000000000000000000000000000000000000000000' metadata={'source': './LongText2.txt'}
0.786843093372851 page_content='111111222222333333444444555555666666777777888888999999101010101010' metadata={'source': './LongText2.txt'}
0.7849433031027981 page_content='888888888888888888888888888888888888888888888888888888888888888888' metadata={'source': './LongText2.txt'}
0.78354449134757 page_content='101010101010999999888888777777666666555555444444333333222222111111' metadata={'source': './LongText2.txt'}

目标匹配排在第四位，甚至第六位，匹配效果并不理想

在数据文本上，现有的相关性，相似度检索并不够用。

### 底部
